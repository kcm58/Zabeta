<!DOCTYPE html>  <html> <head>   <title>mora/db/__index__.py</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               mora/db/__index__.py             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <pre><code>(c) 2012 James Dean Palmer
(c) 2007 Google Inc.
Mora may be freely distributed under the Apache 2.0
licence.  You may obtain a copy of this license at
http://www.apache.org/licenses/LICENSE-2.0

For all details and coumentation:
http://jdpalmer.github.com/mora
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p><em>Mora</em> provides restful services and richer <a href="http://www.json.org/" title="JavaScript Object Notation">JSON</a> support for
<a href="http://code.google.com/appengine/" title="Google App Engine">Google App Engine</a> (GAE). Mora intends to be lightweight and
unobtrusive.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h2>Motivation</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>One of the most important things that Mora adds to GAE models and
properties is a mechanism for generating JSON.  I have adopted
<a href="http://rubyonrails.org/" title="Ruby on Rails">Rails</a>-style <code>to_json</code> and <code>as_json</code> methods and have
specifically avoided placing this logic in a <a href="http://docs.python.org/library/json.html" title="JSON in Python">JSONEncoder</a>
subclass.  There's a few reasons for this - the first is that such a
subclass would have to know about all of App Engine's types and
models.  If you add new types and classes you have to modify or
further subclass the encoder. And if third-party libraries use their
own JSONEncoder subclass, you have the unenviable task of patching
the variations to work together. There's also a real danger in
putting business logic in your encoder because the easy to place to
filter and manipulate JSON properties is where they are being
generated.  Last time I checked there was no
Model-View-Controller-JSONEncoder paradigm.  The JSONEncoder is the
wrong place to make view decisions or business logic decisions.</p>

<p>Rails has split the JSON rendering process into <a href="http://jonathanjulian.com/2010/04/rails-to_json-or-as_json/" title="Rails to_json or as_json?">two parts</a>.
A method called <code>as_json</code> is used to build a representation made of
core JSON-types.  <code>as_json</code> is the smart half of the equation and
belongs to the Model and can make business logic decisions.
<code>to_json</code> then calls the json encoder and that's pretty much all it
does.</p>

<p>Mora adopts this philoshopy and adds <code>as_json</code> to GAE's models <em>and</em>
types.  If you add new models and types and also add the <code>as_json</code>
method it will all just work (TM).</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h2>Dependencies</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>We import some standard modules and also Google App Engine's <code>db</code>
and <code>polymodel</code> modules.  We have to dig at GAE's guts a bit to
shoehorn in better per type JSON support but most of this can be
accomplished with simple subclassing.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">google.appengine.ext</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">google.appengine.ext.db</span> <span class="kn">import</span> <span class="n">polymodel</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>GAE supports a couple of versions of Python and the GAE environment.
We will try to use the latest modules and then use <code>ImportError</code>
exceptions to select older variations.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">json</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">simplejson</span> <span class="k">as</span> <span class="n">json</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">webapp2</span> <span class="kn">as</span> <span class="nn">webapp</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">google.appengine.ext</span> <span class="kn">import</span> <span class="n">webapp</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <h2>Keys and Errors</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>These remain unchanged so we simply import them into this namespace.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="n">Error</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Error</span>
<span class="n">BadValueError</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">BadValueError</span>
<span class="n">BadPropertyError</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">BadPropertyError</span>
<span class="n">BadRequestError</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">BadRequestError</span>
<span class="n">EntityNotFoundError</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">EntityNotFoundError</span>
<span class="n">BadArgumentError</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">BadArgumentError</span>
<span class="n">QueryNotFoundError</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">QueryNotFoundError</span>
<span class="n">TransactionNotFoundError</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">TransactionNotFoundError</span>
<span class="n">Rollback</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Rollback</span>
<span class="n">TransactionFailedError</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">TransactionFailedError</span>
<span class="n">BadFilterError</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">BadFilterError</span>
<span class="n">BadQueryError</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">BadQueryError</span>
<span class="n">BadKeyError</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">BadKeyError</span>
<span class="n">InternalError</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">InternalError</span>
<span class="n">NeedIndexError</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">NeedIndexError</span>
<span class="n">ReferencePropertyResolveError</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">ReferencePropertyResolveError</span>
<span class="n">Timeout</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Timeout</span>
<span class="n">CommittedButStillApplying</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">CommittedButStillApplying</span>
<span class="n">ValidationError</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">ValidationError</span>

<span class="n">Key</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Key</span>
<span class="n">Category</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Category</span>
<span class="n">Link</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Link</span>
<span class="n">Email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Email</span>
<span class="n">GeoPt</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">GeoPt</span>
<span class="n">IM</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">IM</span>
<span class="n">PhoneNumber</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">PhoneNumber</span>
<span class="n">PostalAddress</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">PostalAddress</span>
<span class="n">Rating</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Rating</span>
<span class="n">Text</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Text</span>
<span class="n">Blob</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Blob</span>
<span class="n">ByteString</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">ByteString</span>
<span class="n">BlobKey</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">BlobKey</span>

<span class="n">NotSavedError</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">NotSavedError</span>
<span class="n">KindError</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">KindError</span>
<span class="n">PropertyError</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">PropertyError</span>
<span class="n">DuplicatePropertyError</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">DuplicatePropertyError</span>
<span class="n">ConfigurationError</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">ConfigurationError</span>
<span class="n">ReservedWordError</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">ReservedWordError</span>
<span class="n">DerivedPropertyError</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">DerivedPropertyError</span>

<span class="n">Query</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Query</span>
<span class="n">get</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h2>Properties</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Since Python is duck-typed, there's really no reason to change the
implementation of db.Property even though we are adding <code>as_json</code> to
all of its subclasses.  We add it here to mirror the original
definition.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="n">Property</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Property</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>We change the other core properties by simply subclassing them with
the same name in a different namespace.  This makes them drop-in
replacements for the original properties but they also have the new
<code>as_json</code> method.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">StringProperty</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">StringProperty</span><span class="p">):</span>

  <span class="k">def</span> <span class="nf">as_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value_for_datastore</span><span class="p">(</span><span class="n">model_instance</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">BooleanProperty</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">BooleanProperty</span><span class="p">):</span>

  <span class="k">def</span> <span class="nf">as_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value_for_datastore</span><span class="p">(</span><span class="n">model_instance</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">IntegerProperty</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">IntegerProperty</span><span class="p">):</span>

  <span class="k">def</span> <span class="nf">as_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value_for_datastore</span><span class="p">(</span><span class="n">model_instance</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">long</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FloatProperty</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">FloatProperty</span><span class="p">):</span>

  <span class="k">def</span> <span class="nf">as_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value_for_datastore</span><span class="p">(</span><span class="n">model_instance</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TextProperty</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">TextProperty</span><span class="p">):</span>

  <span class="k">def</span> <span class="nf">as_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value_for_datastore</span><span class="p">(</span><span class="n">model_instance</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ByteStringProperty</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">ByteStringProperty</span><span class="p">):</span>

  <span class="k">def</span> <span class="nf">as_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value_for_datastore</span><span class="p">(</span><span class="n">model_instance</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">EmailProperty</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">EmailProperty</span><span class="p">):</span>

  <span class="k">def</span> <span class="nf">as_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value_for_datastore</span><span class="p">(</span><span class="n">model_instance</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PostalAddressProperty</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">PostalAddressProperty</span><span class="p">):</span>

  <span class="k">def</span> <span class="nf">as_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value_for_datastore</span><span class="p">(</span><span class="n">model_instance</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>There is no standard for date representation in JSON.  We use
ISO8601 for representing time which is pretty common.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">DateTimeProperty</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTimeProperty</span><span class="p">):</span>

  <span class="k">def</span> <span class="nf">as_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value_for_datastore</span><span class="p">(</span><span class="n">model_instance</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(</span><span class="s">&quot;T&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;+00:00&quot;</span>


<span class="k">class</span> <span class="nc">DateProperty</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateProperty</span><span class="p">):</span>

  <span class="k">def</span> <span class="nf">as_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value_for_datastore</span><span class="p">(</span><span class="n">model_instance</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(</span><span class="s">&quot;T&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;+00:00&quot;</span>


<span class="k">class</span> <span class="nc">TimeProperty</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">TimeProperty</span><span class="p">):</span>

  <span class="k">def</span> <span class="nf">as_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value_for_datastore</span><span class="p">(</span><span class="n">model_instance</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(</span><span class="s">&quot;T&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;+00:00&quot;</span>


<span class="k">class</span> <span class="nc">ListProperty</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">ListProperty</span><span class="p">):</span>

  <span class="k">def</span> <span class="nf">as_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value_for_datastore</span><span class="p">(</span><span class="n">model_instance</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>TODO: Flatten each item inside the list</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">StringListProperty</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">StringListProperty</span><span class="p">):</span>

  <span class="k">def</span> <span class="nf">as_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value_for_datastore</span><span class="p">(</span><span class="n">model_instance</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>TODO: Flatten each item inside the list</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">UserProperty</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">UserProperty</span><span class="p">):</span>

  <span class="k">def</span> <span class="nf">as_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value_for_datastore</span><span class="p">(</span><span class="n">model_instance</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="p">{}</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="p">{</span><span class="s">&quot;nickname&quot;</span><span class="p">:</span> <span class="n">value</span><span class="o">.</span><span class="n">nickname</span><span class="p">(),</span>
              <span class="s">&quot;email&quot;</span><span class="p">:</span> <span class="n">value</span><span class="o">.</span><span class="n">email</span><span class="p">(),</span>
              <span class="s">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">value</span><span class="o">.</span><span class="n">user_id</span><span class="p">(),</span>
              <span class="s">&quot;federated_identity&quot;</span><span class="p">:</span> <span class="n">value</span><span class="o">.</span><span class="n">federated_identity</span><span class="p">(),</span>
              <span class="s">&quot;federated_provider&quot;</span><span class="p">:</span> <span class="n">value</span><span class="o">.</span><span class="n">federated_provider</span><span class="p">()}</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <h2>ReferenceProperty</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>The <code>ReferenceProperty</code> likewise has a simple <code>as_json</code> method
similar to the properties we defined above, but I'm taking this
opportunity to fix one of GAE's misfeatures.  When you create a
reference in GAE it creates a backreference in the referenced
class. It's this kind of thing that is exactly what I hate about
Rails. It represents bad code in so many ways:</p>

<ul>
<li>The name of the reference is not in the class that gets it which
violates the principal of structural locality. If we defined all
objects like this it would be a mess.</li>
<li>It's added wether you use it or not.  If we could refactor these
out, we would.  But we can't.  Unused code is a liability.</li>
<li>Auto-generated names can conflict - meaning you have to deal with
these reverse references even if you don't want them and you never
use them.</li>
</ul>

<p>GAE's model system is very much based on Django's but Google left
out an important Django feature.  The equivalent of
ReferenceProperties in Django can have string class specifiers.
This is huge because Python can't deal with circular imports and
thus circular references are impossible to implement.  We accomplish
this by resolving the reference class later and look up the
reference class as needed.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">ReferenceProperty</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">ReferenceProperty</span><span class="p">):</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
               <span class="n">reference_class</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">verbose_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="o">**</span><span class="n">attrs</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">ReferenceProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">verbose_name</span><span class="p">,</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">reference_class</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">reference_class</span> <span class="o">=</span> <span class="n">Model</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">reference_class</span> <span class="o">=</span> <span class="n">reference_class</span>

  <span class="k">def</span> <span class="nf">__property_config__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">property_name</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">ReferenceProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__property_config__</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span>
                                                          <span class="n">property_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_class</span> <span class="ow">is</span> <span class="n">db</span><span class="o">.</span><span class="n">_SELF_REFERENCE</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">reference_class</span> <span class="o">=</span> <span class="n">model_class</span>

  <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datastore</span><span class="o">.</span><span class="n">Key</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">value</span>

    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">value</span><span class="o">.</span><span class="n">has_key</span><span class="p">():</span>
      <span class="k">raise</span> <span class="n">BadValueError</span><span class="p">(</span>
          <span class="s">&#39;</span><span class="si">%s</span><span class="s"> instance must have a complete key before it can be stored as a &#39;</span>
          <span class="s">&#39;reference&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_class</span><span class="o">.</span><span class="n">kind</span><span class="p">())</span>

    <span class="n">value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">ReferenceProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_class</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_class</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">_kind_map</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reference_class</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">_kind_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_class</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">KindError</span><span class="p">(</span><span class="s">&#39;Property has undefined class type </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_class</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_class</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span>
             <span class="nb">issubclass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_class</span><span class="p">,</span> <span class="n">Model</span><span class="p">))</span> <span class="ow">or</span>
            <span class="n">reference_class</span> <span class="ow">is</span> <span class="n">db</span><span class="o">.</span><span class="n">_SELF_REFERENCE</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">KindError</span><span class="p">(</span><span class="s">&#39;reference_class must be Model or _SELF_REFERENCE&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_class</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">KindError</span><span class="p">(</span><span class="s">&#39;Property </span><span class="si">%s</span><span class="s"> must be an instance of </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_class</span><span class="o">.</span><span class="n">kind</span><span class="p">()))</span>

    <span class="k">return</span> <span class="n">value</span>

  <span class="k">def</span> <span class="nf">as_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value_for_datastore</span><span class="p">(</span><span class="n">model_instance</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <h2>ReverseReferenceProperty</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Although I hate autogenerated reverse references, reverse references
themselves are pretty useful and so we make this class public and
add support for string reference class specifiers.</p>

<p>Note that we derive ReverseReferenceProperty from object to avoid
being detected as a property. The original code avoids this by
binding the property later.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">ReverseReferenceProperty</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">prop</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__model</span> <span class="o">=</span> <span class="n">model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__property</span> <span class="o">=</span> <span class="n">prop</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__model</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">__model</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">class_for_kind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__model</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__model</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">_prop_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Internal helper to access the property name, read-only.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__property</span>

  <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">,</span> <span class="n">model_class</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">model_instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__property</span> <span class="o">+</span> <span class="s">&#39; =&#39;</span><span class="p">,</span> <span class="n">model_instance</span><span class="o">.</span><span class="n">key</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span>

  <span class="k">def</span> <span class="nf">__property_config__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">):</span>
      <span class="k">pass</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <h2>Computed Properties</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>We provide a replacement for GAE's <code>ComputedProperty</code> that differs
from the original in a few ways.  First, we have seperated the class
from the decorator so that the decorator can take arguments.  These
arguments allow us to set a return type to associate with the
property.  And second, we have added an <code>as_json</code> method that uses
this type to produce an appropriate representation for the JSON
encoder.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">ComputedProperty</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Property</span><span class="p">):</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value_function</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">indexed</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
      <span class="nb">super</span><span class="p">(</span><span class="n">ComputedProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">indexed</span><span class="o">=</span><span class="n">indexed</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">__value_function</span> <span class="o">=</span> <span class="n">value_function</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_kind</span> <span class="o">=</span> <span class="n">kind</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>

  <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">db</span><span class="o">.</span><span class="n">DerivedPropertyError</span><span class="p">(</span>
          <span class="s">&#39;Computed property </span><span class="si">%s</span><span class="s"> cannot be set.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">,</span> <span class="n">model_class</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">model_instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="k">return</span> <span class="bp">self</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__value_function</span><span class="p">(</span><span class="n">model_instance</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">as_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_instance</span><span class="p">):</span>
      <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get__</span><span class="p">(</span><span class="n">model_instance</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kind</span><span class="o">.</span><span class="n">as_json</span><span class="p">(</span><span class="n">model_instance</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>We use a decorator class to return a <code>ComputedProperty</code>.  Python's
documentation on how this sort of thing works is a bit weak but
Bruce Eckel has put together a nice <a href="http://www.artima.com/weblogs/viewpost.jsp?thread=240845" title="Python Decorators II: Decorator Arguments">decorator tutorial</a> that
demonstrates advanced decorator usage.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">computed_property</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">indexed</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">indexed</span> <span class="o">=</span> <span class="n">indexed</span>

  <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ComputedProperty</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">func_name</span><span class="p">,</span> <span class="n">indexed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">indexed</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <h2>Models</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Ideally I'd like Models to be drop in replacement in the same way
that types are but GAE keeps a map of model names and also does a
several special checks such that db.Model acts differently than its
subclasses. Building pluggable replacements is therefore difficult.
Instead, we let Model be db.Model and then we define our own variants.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="n">Model</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Model</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Our model variations have a lot of shared functionality that we push
into a mixin.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">ModelMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">_json_dumps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{},</span> <span class="n">include</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">as_json</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="n">include</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{},</span> <span class="n">include</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_json</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">include</span><span class="p">,</span> <span class="n">exclude</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Most of the clever stuff happens here.  We iterate through the
properties checking them against the properties we should expose
(via <code>include</code> and <code>exclude</code>).  We then call the individual
properties' <code>as_json</code> methods to build the final representation.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_as_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{},</span> <span class="n">include</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">available_properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">include</span><span class="p">:</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="n">include</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">exclude</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
                    <span class="n">properties</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;_&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">available_properties</span><span class="p">:</span>
                <span class="n">p_kind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">()[</span><span class="n">p</span><span class="p">]</span>
                <span class="n">result</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_kind</span><span class="o">.</span><span class="n">as_json</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Since overriding <code>as_json</code> is pretty common and calling super
class methods is a pain in Python, we put the core behavior in
<code>_as_json</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">as_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{},</span> <span class="n">include</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_as_json</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">include</span><span class="p">,</span> <span class="n">exclude</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Likewise we can extract a representation from json. TODO.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_from_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{},</span> <span class="n">include</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">available_properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">include</span><span class="p">:</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="n">include</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">exclude</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
                    <span class="n">properties</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">available_properties</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">p</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">from_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{},</span> <span class="n">include</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_json</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">include</span><span class="p">,</span> <span class="n">exclude</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <h2>MoraModel</h2>

<p>We use our mixin to define Mora's base model.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">MoraModel</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">ModelMixin</span><span class="p">):</span>

    <span class="nd">@computed_property</span><span class="p">(</span><span class="n">StringProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_saved</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">())</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>We also add the method class<em>name to our base model to mirror
the class</em>name method in Google's PolyModel class.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">class_name</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">kind</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <h2>MoraPolyModel</h2>

<p>And we also use our mixin to define Mora's base polymodel.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">MoraPolyModel</span><span class="p">(</span><span class="n">polymodel</span><span class="o">.</span><span class="n">PolyModel</span><span class="p">,</span> <span class="n">ModelMixin</span><span class="p">):</span>

    <span class="nd">@computed_property</span><span class="p">(</span><span class="n">StringProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_saved</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">())</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span>


<span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="n">_class</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">class_for_kind</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_class</span><span class="p">()</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 
