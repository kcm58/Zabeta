<!DOCTYPE html>  <html> <head>   <title>mora/rest/__index__.py</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               mora/rest/__index__.py             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <pre><code>(c) 2012 James Dean Palmer
Mora may be freely distributed under the Apache 2.0
licence.  You may obtain a copy of this license at
http://www.apache.org/licenses/LICENSE-2.0

For all details and coumentation:
http://jdpalmer.github.com/mora
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p><em>Mora</em> provides restful services and richer JSON support for Google
App Engine (GAE). Mora intends to be lightweight and unobtrusive.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h2>Motivation</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>This module provides a dispatcher and REST handler class you can use
to make your own RESTful graphs. A RESTful graph API has an
organization similar to Facebook's graph api and is a bit
different than the default way most other frameworks implement REST.</p>

<p>To get a Student object with Mora you might send a GET request to:</p>

<pre><code>/graph/ag9kZXZ-YmVhbmdyaW5kZXJyCgsSBFVzZXIYAQw
</code></pre>

<p>You don't specify that you want a user resource because GAE already
has this embedded in the key.  You can then use PUT and DELETE http
verbs to update and remove the object.  Now if you want to get a
list of courses the user is in, you send a GET to:</p>

<pre><code>/graph/ag9kZXZ-YmVhbmdyaW5kZXJyCgsSBFVzZXIYAQw/courses
</code></pre>

<p>And if you want to add a course, you send a POST to the same URL.
There are no nested resource calls because they are unneccessary.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h2>Dependencies</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>We import some standard modules and also Google App Engine's <code>db</code>
and <code>polymodel</code> modules.  We have to dig at GAE's guts a bit to
shoehorn in better per type JSON support but most of this can be
accomplished with simple subclassing.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">from</span> <span class="nn">mora</span> <span class="kn">import</span> <span class="n">db</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>GAE supports a couple of versions of Python and the GAE environment.
We will try to use the latest modules and then use <code>ImportError</code>
exceptions to select older variations.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">json</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">simplejson</span> <span class="k">as</span> <span class="n">json</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">webapp2</span> <span class="kn">as</span> <span class="nn">webapp</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">google.appengine.ext</span> <span class="kn">import</span> <span class="n">webapp</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <h2>Decorators</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p><code>show</code>, <code>update</code>, and <code>delete</code> are the only named REST action
methods in <code>RestHandler</code>.  All other REST actions must be
accomplished with special method decorators.  These decorators
attach REST HTTP verbs to functions.</p>

<p>To setup an index for courses, we could write:</p>

<pre><code> @rest_index("courses")
 def course_list(self):
     # return the courses..
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">def</span> <span class="nf">rest_index</span><span class="p">(</span><span class="n">keyword</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">wrapped</span><span class="p">,</span> <span class="s">&quot;_mora_verb&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;GET &quot;</span> <span class="o">+</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">func_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">wrapped</span>
    <span class="k">return</span> <span class="n">wrap</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Similarly we might want to be able to add a new course.  rest_create
attaches the POST verb to a function so that we can write:</p>

<pre><code> @rest_create("courses")
 def course_create(self):
     # create a course..
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">def</span> <span class="nf">rest_create</span><span class="p">(</span><span class="n">keyword</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">wrapped</span><span class="p">,</span> <span class="s">&quot;_mora_verb&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;POST &quot;</span> <span class="o">+</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">func_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">wrapped</span>
    <span class="k">return</span> <span class="n">wrap</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>And there may be some occasions where you need to take some special
action on an item that doesn't fall into one of the usual 'index',
'create', 'update', 'destroy', or 'show' actions.  These should be
annotated with the rest_action decorator:</p>

<pre><code> @rest_create("like")
 def like(self):
     # execute a like action on the user
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">def</span> <span class="nf">rest_action</span><span class="p">(</span><span class="n">keyword</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">wrapped</span><span class="p">,</span> <span class="s">&quot;_mora_verb&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;POST &quot;</span> <span class="o">+</span> <span class="n">keyword</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">func_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">wrapped</span>
    <span class="k">return</span> <span class="n">wrap</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <h2>Dispatcher Exceptions</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>DispatchErrors may be thrown when something goes wrong and will be
caught at the RequestHandler stage.  When you throw an error you
should set the code and message.  Some standard codes and messages
that Mora throws internally include:</p>

<ul>
<li>400: InvalidHttpVerb</li>
<li>400: InvalidUri</li>
<li>404: ResourceNotFound</li>
<li>405: UnsupportedHttpVerb</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">DispatchError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DispatchError</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <h2>REST Dispatcher</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>The <code>RestDispatcher</code> is a request handler that gets passed to
webapp.  We then spawn our custom RestHandlers from here.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">RestDispatcher</span><span class="p">(</span><span class="n">webapp</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>

    <span class="n">base_path</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
    <span class="n">rest_handlers</span> <span class="o">=</span> <span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>We setup the dispatcher with a path it should use and a list of
RestHandlers connected to specific models.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">handlers</span><span class="p">):</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">base_path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="k">for</span> <span class="n">rest_handler</span> <span class="ow">in</span> <span class="n">handlers</span><span class="p">:</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">rest_handler</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>We pass back a reference to the base_path and this class as the
routing pair.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">route</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">base_path</span> <span class="o">+</span> <span class="s">&quot;/.*&quot;</span><span class="p">,</span> <span class="n">RestDispatcher</span><span class="p">)</span>


    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">rest_handler</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">rest_handler</span><span class="o">.</span><span class="n">model</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">rest_handlers</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">rest_handler</span>

        <span class="n">verbs</span> <span class="o">=</span> <span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>When we connect RestHandler subclasses to this class we also
scan their methods looking for methods that were decorated
as rest actions.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">rest_handler</span><span class="o">.</span><span class="n">__class__</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s">&quot;_mora_verb&quot;</span><span class="p">):</span>
                <span class="n">verbs</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s">&quot;_mora_verb&quot;</span><span class="p">)])</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>We also include the standard rest methods.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">verbs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&quot;GET __self__&quot;</span><span class="p">:</span> <span class="s">&quot;show&quot;</span><span class="p">,</span>
                      <span class="s">&quot;DELETE __self__&quot;</span><span class="p">:</span> <span class="s">&quot;destroy&quot;</span><span class="p">,</span>
                      <span class="s">&quot;PUT __self__&quot;</span><span class="p">:</span> <span class="s">&quot;update&quot;</span><span class="p">})</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>We then attach this list of actions to the class.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nb">setattr</span><span class="p">(</span><span class="n">rest_handler</span><span class="p">,</span> <span class="s">&quot;_mora_verbs&quot;</span><span class="p">,</span> <span class="n">verbs</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">request</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">response</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">RestDispatcher</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">RestDispatcher</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>The standard http verb methods are rerouted to the action method.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">(</span><span class="s">&#39;GET&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">(</span><span class="s">&#39;PUT&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">(</span><span class="s">&#39;DELETE&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">(</span><span class="s">&#39;POST&#39;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">act</span><span class="p">,</span> <span class="n">exceptions</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>The action method handles exceptions by recursively calling
itself such that we have one spot that we can catch
<code>DispatchError</code>s.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="n">exceptions</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">(</span><span class="n">act</span><span class="p">,</span> <span class="n">exceptions</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">DispatchError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Error &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">code</span><span class="p">))</span>
            <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>We also support a special <code>_method</code> argument to change the
HTTP verb being used.  This is to support browsers with poor
support for making AJAX calls with arbitrary HTTP verbs and
other oddball cases.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;_method&quot;</span><span class="p">):</span>
            <span class="n">act</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;_method&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">act</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;POST&quot;</span><span class="p">,</span> <span class="s">&quot;DELETE&quot;</span><span class="p">,</span> <span class="s">&quot;PUT&quot;</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="n">DispatchError</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="s">&quot;InvalidHttpVerb&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>In order to respond to a request, we have to build a path
and remove the <code>base_path</code> prefix from it.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">path</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_path</span><span class="p">)):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_path</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="n">path</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">))</span>
        <span class="n">path</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>The key is now the first element in the path.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">key</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>We obtain the model instance from the key.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">db</span><span class="o">.</span><span class="n">BadKeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DispatchError</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="s">&quot;ResourceNotFound&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>We then can use the model to create an appropriate handler.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">kind</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rest_handlers</span><span class="p">:</span>
            <span class="n">rest_handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rest_handlers</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">kind</span><span class="p">()](</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
            <span class="n">rest_handler</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DispatchError</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="s">&quot;ResourceNotFound&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>If nothing follows the key, we assume the action is on the
current object ("<strong>self</strong>").  Otherwise we capture a keyword
that represents a path or alternate action to take.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">keyword</span> <span class="o">=</span> <span class="s">&quot;__self__&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">keyword</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DispatchError</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="s">&quot;InvalidUri&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>We then use the HTTP verb and keyword to lookup the method
to call.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">action_key</span> <span class="o">=</span> <span class="n">act</span> <span class="o">+</span> <span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="n">keyword</span>
        <span class="k">if</span> <span class="n">action_key</span> <span class="ow">in</span> <span class="n">rest_handler</span><span class="o">.</span><span class="n">_mora_verbs</span><span class="p">:</span>
            <span class="n">action_method</span> <span class="o">=</span> <span class="n">rest_handler</span><span class="o">.</span><span class="n">_mora_verbs</span><span class="p">[</span><span class="n">action_key</span><span class="p">]</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rest_handler</span><span class="p">,</span> <span class="n">action_method</span><span class="p">)()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DispatchError</span><span class="p">(</span><span class="mi">405</span><span class="p">,</span> <span class="s">&quot;UnsupportedHttpVerb&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <h2>RestHandler</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>The RestHandler is attached to the model, request, and response.
You can override the provided <code>show</code>, <code>update</code> and <code>delete</code> methods
or create new methods.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nc">RestHandler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">_mora_verbs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">response</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">arguments</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>REST methods should be very lightweight.  Use the as_json method
to push business logic into the model.  Here are some example
implementations for each method:</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Example:</p>

<pre><code>def show(self):
  self.response.out.write(self.model.to_json())
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">DispatchError</span><span class="p">(</span><span class="mi">405</span><span class="p">,</span> <span class="s">&quot;UnsupportedHttpVerb&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Example:</p>

<pre><code>def update(self):
  self.model.from_json(self.params)
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">DispatchError</span><span class="p">(</span><span class="mi">405</span><span class="p">,</span> <span class="s">&quot;UnsupportedHttpVerb&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Example:</p>

<pre><code>def destroy(self):
  self.model.delete()
  self.response.out.write({})
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">destroy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">DispatchError</span><span class="p">(</span><span class="mi">405</span><span class="p">,</span> <span class="s">&quot;UnsupportedHttpVerb&quot;</span><span class="p">)</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 
